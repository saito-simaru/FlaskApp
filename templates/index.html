<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>リアルタイム画像表示</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>
  <h1>生成された画像</h1>
  <img id="generated" src="{{ url_for('static', filename=image_path) }}" alt="画像">

  <div id="infoText" class="text">初期メッセージ</div>
  <button id="actionButton" class="hidden">画像確認</button>

<script>
  const img = document.getElementById('generated');
  const button = document.getElementById('actionButton');
  const infoText = document.getElementById('infoText');

  let lastImageTime = 0;

  async function checkImageUpdate() {
    try {
      const res = await fetch('/image_status');
      const data = await res.json();

      if (data.last_updated > lastImageTime) {
        // 更新されていたら画像を再読み込み
        refreshImage();
        lastImageTime = data.last_updated;
      }
    } catch (err) {
      console.error('エラー:', err);
    }
  }

  function refreshImage() {
    const timestamp = new Date().getTime();
    img.src = `/static/images/generated_image.jpg?t=${timestamp}`;

    button.classList.remove("hidden");
    button.disabled = false;

    infoText.textContent = "新しい画像が生成されました！";
  }

button.addEventListener('click', async () => {
  alert("ボタンがクリックされました");

  // ボタンを非表示＋無効化
  button.disabled = true;
  button.classList.add("hidden");

  // Flaskに通知（画像生成スクリプトに再開を伝える）
  await fetch('/button_clicked', {
    method: 'POST'
  });
});

  // 3秒ごとに更新チェック
  setInterval(checkImageUpdate, 3000);
</script>
</body>
</html>
