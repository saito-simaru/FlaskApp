<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>リアルタイム画像表示</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>
  <h1>生成された画像</h1>
  <img id="generated" src="static/images/no.jpg" alt="画像">

  <div id="infoText" class="text">初期メッセージ</div>
  <button id="actionButton" class="hidden">画像確認</button>

<script>
  const img = document.getElementById('generated');
  const button = document.getElementById('actionButton');
  const infoText = document.getElementById('infoText');

  let lastImageTime = 0;
  let shouldCheckSystemStatus = false; // ← 状態フラグ！

  async function checkImageUpdate() {
    try {
      
      const res = await fetch('/image_status');
      const data = await res.json();
      console.log("更新時間" + data.last_updated + " : 最終画像の更新時間" + lastImageTime);


      if (data.last_updated > lastImageTime) {
        refreshImage();
        lastImageTime = data.last_updated;
      }
    } catch (err) {
      console.error('画像チェックエラー:', err);
    }
  }

  async function refreshImage() {
    await fetch('/create_flag', { method: 'POST' });
    const timestamp = new Date().getTime();
    img.src = `/static/images/generated_image.jpg?t=${timestamp}`;
    button.classList.remove("hidden");
    button.disabled = false;
    infoText.textContent = "新しい画像が生成されました！";
    console.log("画像を更新");

    // 🔴 状態フラグOFF → checkSystemStatus を一時停止
    shouldCheckSystemStatus = false;
  }

  async function checkSystemStatus() {
    console.log("システムチェック前");
    if (!shouldCheckSystemStatus) return; // 🔴 呼び出しブロック！
    console.log("システムチェック通過");
    try {
      const res = await fetch('/system_status');
      const data = await res.json();

      if (data.status === true) {
        img.src = '/static/images/yes.jpg';
        infoText.textContent = "外部ステータス：TRUE（待機中）";
        button.classList.add("hidden");
        console.log("〇画像を表示");
      } else {
        img.src = '/static/images/no.jpg';
        infoText.textContent = "外部ステータス：FALSE（待機中）";
        button.classList.add("hidden");
      }
      console.log("〇画像を表示end");
    } catch (err) {
      console.error('ステータス読み込みエラー:', err);
    }
  }

  button.addEventListener('click', async () => {
    console.log("ボタンがクリックされました");

    button.disabled = true;
    button.classList.add("hidden");

    // 🔵 状態フラグON → checkSystemStatus を再開
    shouldCheckSystemStatus = true;

    await fetch('/button_clicked', { method: 'POST' });
  });

  // 3秒ごとに定期チェック（状態フラグによって分岐）
  setInterval(() => {
    checkImageUpdate();
    checkSystemStatus(); // フラグによって無効化・再開
  }, 1000);
  //   setInterval(() => {
  //   checkSystemStatus(); // フラグによって無効化・再開
  // }, 3000);
</script>


</body>
</html>
