<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”»åƒè¡¨ç¤º</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>
  <h1>Captured image</h1>
  <img id="generated" src="static/images/no.jpg" alt="ç”»åƒ">

  <div id="infoText" class="text"></div>
  <!-- <button id="actionButton" class="hidden">continue</button> -->

<script>
  const img = document.getElementById('generated');
  // const button = document.getElementById('actionButton');
  const infoText = document.getElementById('infoText');

  let lastImageTime = 0;
  //let shouldCheckSystemStatus = false; // â† çŠ¶æ…‹ãƒ•ãƒ©ã‚°ï¼

  async function checkImageUpdate() {
    try {
      
      const res = await fetch('/image_status');
      const data = await res.json();
      console.log("æ›´æ–°æ™‚é–“" + data.last_updated + " : æœ€çµ‚ç”»åƒã®æ›´æ–°æ™‚é–“" + lastImageTime);

      if (data.last_updated > lastImageTime) {
        await refreshImage();
        lastImageTime = data.last_updated;
        // checkSystemStatus();
      }
      // else
      // {
      //   checkSystemStatus();
      // }
    } catch (err) {
      console.error('ç”»åƒãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  async function refreshImage() {
    //await fetch('/create_flag', { method: 'POST' });
    console.log('è¦ç´ ã¯ hidden ã‚¯ãƒ©ã‚¹ã‚’æŒã£ã¦ã„ã¾ã™');
    const timestamp = new Date().getTime();
    img.src = `/static/images/generated_image.jpg?t=${timestamp}`;
    button.classList.remove("hidden");
    button.disabled = false;
    infoText.textContent = "Get Tsukumo image!!";
    console.log("ç”»åƒã‚’æ›´æ–°");

    // ğŸ”´ çŠ¶æ…‹ãƒ•ãƒ©ã‚°OFF â†’ checkSystemStatus ã‚’ä¸€æ™‚åœæ­¢
    //shouldCheckSystemStatus = false;
  }

  // async function checkSystemStatus() {  
  //   if (!button.classList.contains('hidden')) {
  //     // ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆç”»åƒç”Ÿæˆã‚’æ­¢ã‚ã‚‹
  //     await fetch('/stopcreate');
  //     console.log('ãƒœã‚¿ãƒ³éè¡¨ç¤ºä¸­');
      
  //   }else{
  //     // ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆç”»åƒç”Ÿæˆã‚’å†é–‹
  //     await fetch('/iscreate');
  //     console.log('ãƒœã‚¿ãƒ³è¡¨ç¤ºä¸­');


  //     if (!shouldCheckSystemStatus) return; // ğŸ”´ å‘¼ã³å‡ºã—ãƒ–ãƒ­ãƒƒã‚¯ï¼
  //     try {
  //       const res = await fetch('/system_status');
  //       const data = await res.json();

  //       if (data.status === true) {
  //         img.src = '/static/images/yes.jpg';
  //         infoText.textContent = "Conecting SOL GLASSES!";
  //         button.classList.add("hidden");
  //         console.log("ã€‡ç”»åƒã‚’è¡¨ç¤º");
  //       } else {
  //         img.src = '/static/images/no.jpg';
  //         infoText.textContent = "Missing SOL GLASSESãƒ»ãƒ»ãƒ»";
  //         button.classList.add("hidden");
  //       }
  //       console.log("ã€‡ç”»åƒã‚’è¡¨ç¤ºend");
  //     } catch (err) {
  //       console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
  //     }
  //   }

  // }

  // button.addEventListener('click', async () => {
  //   console.log("ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");

  //   button.disabled = true;
  //   button.classList.add("hidden");

  //   // ğŸ”µ çŠ¶æ…‹ãƒ•ãƒ©ã‚°ON â†’ checkSystemStatus ã‚’å†é–‹
  //   shouldCheckSystemStatus = true;
  // });

  // 0.5ç§’ã”ã¨ã«å®šæœŸãƒã‚§ãƒƒã‚¯ï¼ˆçŠ¶æ…‹ãƒ•ãƒ©ã‚°ã«ã‚ˆã£ã¦åˆ†å²ï¼‰
  setInterval(() => {
    checkImageUpdate();
     // ãƒ•ãƒ©ã‚°ã«ã‚ˆã£ã¦ç„¡åŠ¹åŒ–ãƒ»å†é–‹
  }, 500);

</script>


</body>
</html>
